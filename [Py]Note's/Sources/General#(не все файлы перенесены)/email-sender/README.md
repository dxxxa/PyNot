# [How to Send Emails in Python using smtplib Module](https://www.thepythoncode.com/article/sending-emails-in-python-smtplib)
Feel free to edit the code how ever you want to suit your needs!
##
# [[] / []]()
Отправка электронных писем вручную, без сомнения, трудоемкая и сложная задача, программист может легко автоматизировать это, используя свой любимый язык программирования, в этом уроке вы узнаете, как вы можете отправлять электронные письма с помощью модуля smtplib в Python, мы также будем использовать модуль электронной почты для отправки различных типов вложений, таких как HTML-контент и двоичные файлы.

SMTP (Simple Mail Transfer Protocol) - это протокол, который обрабатывает отправку и маршрутизацию электронной почты между почтовыми серверами, это протокол связи для передачи электронной почты, он был впервые представлен в 1982 году и обновлен в 2008 году RFC 5321 до Extended SMTP дополнения (которые используются сегодня). Итак, в двух словах, почтовые серверы используют этот сетевой протокол для отправки почтовых сообщений.

Модуль smtplib использует протокол SMTP и определяет объект сеанса клиента SMTP, который можно использовать для отправки почты на любой компьютер в Интернете с прослушивателем SMTP (или Extended-SMTP). Он поставляется с предустановленным с Python, поэтому нам не нужно его устанавливать.

Обратите внимание, что код этого учебника больше не работает в учетных записях Gmail, если вы хотите отправлять электронные письма с помощью Gmail, вы можете использовать API Gmail.

Прежде чем мы начнем, давайте установим BeautifulSoup, который поможет нам автоматически извлекать обычный текст из HTML, не беспокоясь о регулярных выражениях:

$ pip3 install bs4
Связанные с: Как читать электронные письма на Python.

Построение нашего послания
Хорошо, давайте начнем, давайте сначала импортируем библиотеки, которые мы собираемся использовать:

import smtplib
from email import encoders
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.mime.base import MIMEBase
from bs4 import BeautifulSoup as bs
Нам понадобится модуль электронной почты, потому что он предоставляет нам стандарт MIME, который поможет нам отправлять не только электронные письма с набором символов ASCII, но и большие наборы символов, HTML и даже двоичные файлы.

Тела сообщений с форматированием MIME состоят из нескольких частей, каждая часть может содержать любой тип данных, которые вы действительно хотите отправить (например, обычный текст, HTML или двоичные файлы).

Определимся с нашими параметрами:

# your credentials
email = "email@example.com"
password = "password"
# the sender's email
FROM = email
# the receiver's email
TO   = "to@example.com"
# the subject of the email (subject)
subject = "Just a subject"
Довольно просто, переменные электронной почты и пароля - это учетные данные адреса электронной почты, который вы хотите отправить. FROM и TO - это электронная почта отправителя и электронная почта получателя соответственно (электронная почта и FROM обычно совпадают), а тема - это название (или тема) письма, которое мы отправим.

Убедитесь, что вы редактируете эти переменные для своих собственных нужд, вы можете отправлять на несколько адресов электронной почты, просто используя список адресов электронной почты в переменной TO вместо строки.

Давайте построим нашу почту, теперь мы будем использовать две версии нашей почты, одна из которых является версией HTML, а другая - текстовой версией. Обычно это относится к большинству поставщиков услуг электронной почты, так как некоторые почтовые клиенты не будут пытаться отобразить HTML-содержимое по соображениям безопасности.

В результате мы собираемся использовать объект MIMEMultipart и передать «alternative» в качестве подтипа, чтобы он мог объединить две версии почты в одно сообщение с двумя вариантами рендеринга:

# initialize the message we wanna send
msg = MIMEMultipart("alternative")
# set the sender's email
msg["From"] = FROM
# set the receiver's email
msg["To"] = TO
# set the subject
msg["Subject"] = subject
Мы также устанавливаем адреса электронной почты От, До и тему. Давайте создадим тело сообщения:

# set the body of the email as HTML
html = """
This email is sent using <b>Python </b>!
"""
# make the text version of the HTML
text = bs(html, "html.parser").text
В этом примере мы установили html на простое HTML-сообщение, но вы можете читать из шаблона почты HTML, например:

# set the body of the email as HTML
html = open("mail.html").read()
# make the text version of the HTML
text = bs(html, "html.parser").text
Если вы хотите использовать версию почтового шаблона, получите mail.html отсюда. Давайте закончим построение сообщения:

text_part = MIMEText(text, "plain")
html_part = MIMEText(html, "html")
# attach the email body to the mail message
# attach the plain text version first
msg.attach(text_part)
msg.attach(html_part)
После построения тела сообщения мы прикрепили его к только что созданному объекту MIMEMultipart. Давайте посмотрим, как выглядит это письмо:

print(msg.as_string())
Выпуск:

Content-Type: multipart/alternative; boundary="===============2952145411990110564=="
MIME-Version: 1.0
From: from@example.com
To: to@example.com
Subject: Just a subject

--===============2952145411990110564==
Content-Type: text/plain; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit


This email is sent using Python !

--===============2952145411990110564==
Content-Type: text/html; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit


This email is sent using <b>Python </b>!

--===============2952145411990110564==--
Как вы можете заметить, каждая часть разделена фиксированным набором символов, первая часть содержит заголовок почты, а вторая содержит фактическое тело сообщения, которое мы только что прикрепили, обратите внимание, что если есть какие-либо символы, отличные от ASCII, он автоматически изменит кодировку для нас, поэтому вам обычно не нужно беспокоиться об этом. Для получения дополнительной информации о стандарте MIME посетите эту страницу Википедии.

В следующих нескольких разделах мы увидим, как мы можем добавлять файлы в виде вложения электронной почты, следите за обновлениями!

Связанные с: Как удалить электронные письма в Python.

Отправка сообщения
Теперь, когда у нас есть почта, готовая к отправке, давайте создадим функцию, которая принимает адреса электронной почты FROM и TO, а также фактический msg для отправки, и он отправит электронное письмо для нас:

def send_mail(email, password, FROM, TO, msg):
    # initialize the SMTP server
    # in our case it's for Microsoft365, Outlook, Hotmail, and live.com
    server = smtplib.SMTP(host="smtp.office365.com", port=587)
    # connect to the SMTP server as TLS mode (secure) and send EHLO
    server.starttls()
    # login to the account using the credentials
    server.login(email, password)
    # send the email
    server.sendmail(FROM, TO, msg.as_string())
    # terminate the SMTP session
    server.quit()
Заметка: С 30 мая 2022 года Google больше не поддерживает использование сторонних приложений или устройств, которые просят вас войти в свой аккаунт Google, используя только свое имя пользователя и пароль. Поэтому этот код не будет работать для учетных записей Gmail. Если вы хотите взаимодействовать со своей учетной записью Gmail на Python, я настоятельно рекомендую вам вместо этого использовать учебник по API Gmail.

Итак, мы сначала подключаемся к SMTP-серверу с помощью smtplib, мы использовали SMTP-сервер Office365 в этом примере с портом 587. Если вы хотите использовать другие SMTP-серверы (например, Yahoo), проверьте список SMTP-серверов и их номера портов. Вы должны выбрать SMTP-сервер учетной записи электронной почты, которую вы хотите использовать в коде.

Затем мы переводим соединение с SMTP-сервером в режим TLS для обеспечения безопасности (с помощью StartTLS),и, наконец, мы входим в систему, используя учетные данные учетной записи, и завершаем сеанс после отправки нашей электронной почты.

Метод server.sendmail() выполняет всю почтовую транзакцию, она принимает несколько аргументов: адрес отправки этого письма (FROM), список адресов для отправки этого письма (если это строка, то она будет рассматриваться как список с 1 адресом) и сообщение для отправки.

Назовем только что созданную нами функцию:

# send the mail
send_mail(email, password, FROM, TO, msg)
После того, как я выполнил приведенный выше код (конечно, я использовал реальные учетные данные электронной почты), вот скриншот полученного электронного письма:

Получено электронное письмо

Открытая электронная почта после получения

Добавление вложений
Чтобы отправить двоичные файлы (такие как документы, изображения, видео, аудиофайлы и т. Д.) В качестве вложения в нашу электронную почту, нам нужно добавить вложение для каждого файла, который мы хотим отправить:

# list of files to send as an attachment to the email
# feel free to add your attachments here
files_to_send = [
    "test.txt",
    "1810.04805.pdf",
]
# initialize the message we wanna send
msg = MIMEMultipart("alternative")
# set the sender's email
msg["From"] = FROM
# set the receiver's email
msg["To"] = TO
# set the subject
msg["Subject"] = subject
# set the body of the email as HTML
html = open("mail.html").read()
# make the text version of the HTML
text = bs(html, "html.parser").text

text_part = MIMEText(text, "plain")
html_part = MIMEText(html, "html")
# attach the email body to the mail message
# attach the plain text version first
msg.attach(text_part)
msg.attach(html_part)
for file in files_to_send:
    # open the file as read in bytes
    with open(file, "rb") as f:
        # read the file content
        data = f.read()
        # create the attachment
        attach_part = MIMEBase("application", "octet-stream")
        attach_part.set_payload(data)
    # encode the data to base 64
    encoders.encode_base64(attach_part)
    # add the header
    attach_part.add_header("Content-Disposition", f"attachment; filename= {file}")
    msg.attach(attach_part)
# send the mail
send_mail(email, password, FROM, TO, msg)
Примечание: приведенный выше код не будет работать как автономный скрипт Python, пожалуйста, обратитесь к этой странице, чтобы получить полную версию кода.

Мы добавляем обычный текст и HTML-вложения, как и раньше, затем перебираем files_to_send список (который содержит список файлов, которые мы хотим отправить, в данном случае текстовый файл и PDF-файл) и прикрепляем каждый файл к нашей почте. Вы можете получить файлы, которые я использовал в этом каталоге.

Конечно, вы можете отправить любой файл, который вы хотите, убедитесь, что вы редактируете files_to_send список, и вы готовы к работе.

Мы использовали подтип application/octet-stream, чтобы указать, что это произвольные двоичные данные, и мы установили данные с помощью метода set_payload(). После этого мы кодируем вложение файла в Base64 и прикрепляем его к почте после добавления заголовка Content-Disposition, чтобы указать, что это вложение.

Вот как это выглядит, когда я отправил письмо:

Полученная почта с вложением

Я настоятельно рекомендую вам проверить полный код, так как вам удобно его копировать.

Заключение
Удивительно, есть много вариантов использования для этого! Вы можете, например, создать свои собственные пользовательские оповещения, чтобы уведомлять вас, когда что-то произошло, или вы хотите отправлять подтверждение по электронной почте пользователям, когда они создают учетную запись на вашем веб-сайте или отправляют электронные письма членам вашей организации, или отправлять результаты кейлоггера, возможности бесконечны!

Вот другие учебные пособия по электронной почте:

Как читать электронные письма на Python.
Как удалить электронные письма в Python.
Как использовать API Gmail в Python.
Другим примером использования этого является то, что вы можете использовать экстрактор электронной почты, чтобы захватить хороший список рассылки из Интернета и отправить маркетинговые кампании для охвата широкой аудитории! Давайте посмотрим, что вы построили с этим в комментариях ниже.